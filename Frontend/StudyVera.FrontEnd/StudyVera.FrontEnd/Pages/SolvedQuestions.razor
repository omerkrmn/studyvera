@page "/profile/solved-questions"
@using StudyVera.FrontEnd.Components
@using StudyVera.FrontEnd.Models.Topics
@using StudyVera.FrontEnd.Models.UserQuestionStat
@using StudyVera.FrontEnd.Services
@using StudyVera.FrontEnd.Services.Concrats
@inject IUserQuestionStatsService UserQuestionStatsService
@inject TopicService TopicService
@inject IJSRuntime JS
@inject HttpClient Http

<PageTitle>Soru Çözme İstatistikleri</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">

    <button class="btn btn-primary btn-lg" @onclick="OpenModalForNew">
        <span class="me-1">➕</span> Yeni
    </button>
</div>

@if (isModalOpen)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <EditForm Model="@newQuestion" OnValidSubmit="AddQuestionAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger p-2" />

                        <div class="row g-3 align-items-end">

                            @* 1. Konu Arama ve Seçme *@
                            <div class="col-md-5 position-relative">
                                <label class="form-label fw-bold">Konu Seçimi</label>
                                <input type="text"
                                       class="form-control form-control-lg"
                                       placeholder="Konu ara veya seç..."
                                       @bind="searchTerm"
                                       @bind:event="oninput"
                                       @onfocus="() => showDropdown = true"
                                       @onblur="HideDropdownDelayed" />

                                @if (showDropdown && FilteredTopics.Any())
                                {
                                    <ul class="list-group position-absolute w-100 shadow-lg mt-1" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        @foreach (var topic in FilteredTopics)
                                        {
                                            <li class="list-group-item list-group-item-action @(newQuestion.TopicId == topic.Id ? "active" : "")"
                                                @onclick="() => SelectTopic(topic)">
                                                @topic.Name
                                            </li>
                                        }
                                    </ul>
                                }
                                <ValidationMessage For="@(() => newQuestion.TopicId)" class="text-danger small" />
                            </div>

                            @* 2. Çözülen Soru Sayısı *@
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Çözülen (Toplam)</label>
                                <InputNumber TValue="int"
                                             @bind-Value="newQuestion.SolvedCount"
                                             class="form-control form-control-lg"
                                             placeholder="Adet" />
                                <ValidationMessage For="@(() => newQuestion.SolvedCount)" class="text-danger small" />
                            </div>

                            @* 3. Doğru Soru Sayısı *@
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Doğru Sayısı</label>
                                <InputNumber TValue="int"
                                             @bind-Value="newQuestion.CorrectCount"
                                             class="form-control form-control-lg"
                                             placeholder="Adet" />
                                <ValidationMessage For="@(() => newQuestion.CorrectCount)" class="text-danger small" />
                            </div>

                            @* 4. Kaydet Butonu *@
                            <div class="col-md-3 d-grid">
                                <button type="submit" class="btn btn-success btn-lg">💾 İlerleme Kaydet</button>
                            </div>

                        </div>

                    </EditForm>
                </div>

            </div>
        </div>
    </div>
}
<SolvedQuestionsList Questions="questions" Topics="Topics" />


@code {

    private List<UserQuestionStatDto> questions = new();
    AddUserQuestionStatDto newQuestion = new();
    private List<TopicDto>? Topics;
    private string searchTerm = string.Empty;
    private bool showDropdown;
    private bool isModalOpen = false;
    private string modalTitle = "Yeni İlerleme Ekle";



    private float konuEksiklikOlcegi = 0.0f;



    private IEnumerable<TopicDto> FilteredTopics =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? new List<TopicDto>()
            : Topics!.Where(t => t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    public async Task AddQuestionAsync()
    {
        try
        {
            await UserQuestionStatsService.Add(newQuestion);
            newQuestion = new AddUserQuestionStatDto();
            searchTerm = string.Empty;
            questions = await UserQuestionStatsService.GetAll();
            await ShowSuccessToast("İlerleme başarıyla kaydedildi! 🎉");
            isModalOpen = false;
        }
        catch (HttpRequestException httpEx) when (httpEx.StatusCode.HasValue)
        {
            var code = ((int)httpEx.StatusCode.Value);
            await ShowErrorToast($"Kayıt sırasında bir hata oluştu. Status Code {code}");
        }
        catch (Exception ex)
        {
            await ShowErrorToast($"Kayıt sırasında beklenmeyen bir hata oluştu. {ex.Message}");
        }
    }
    private void SelectTopic(TopicDto topic)
    {
        newQuestion.TopicId = topic.Id;
        searchTerm = topic.Name;
        showDropdown = false;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Topics = await TopicService.GetTopics();
            questions = await UserQuestionStatsService.GetAll();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Veri yükleme hatası: {ex.Message}");
        }
    }

    private CancellationTokenSource cts = new CancellationTokenSource();

    private void HideDropdownDelayed()
    {
        cts.Cancel();
        cts = new CancellationTokenSource();
        _ = Task.Delay(200, cts.Token)
                .ContinueWith(t =>
                {
                    if (!t.IsCanceled)
                    {
                        showDropdown = false;
                        InvokeAsync(StateHasChanged);
                    }
                });
    }

    private async Task ShowSuccessToast(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    private async Task ShowErrorToast(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    // ----- Modal aç/kapa metotları -----

    private void OpenModalForNew()
    {
        newQuestion = new AddUserQuestionStatDto();
        searchTerm = string.Empty;
        showDropdown = false;

        modalTitle = "Yeni İlerleme Ekle";
        isModalOpen = true;
    }

    private void OpenModalForTopic(UserQuestionStatDto question)
    {
        // Konu otomatik gelsin
        newQuestion = new AddUserQuestionStatDto
        {
            TopicId = question.Topic.Id
        };

        searchTerm = question.Topic.Name;
        showDropdown = false;

        modalTitle = $"{question.Topic.Name} için yeni ilerleme ekle";
        isModalOpen = true;
    }

    private void CloseModal()
    {
        isModalOpen = false;
    }

   

}
