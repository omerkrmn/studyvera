@page "/auth/register"
@using StudyVera.FrontEnd.Enums
@using StudyVera.FrontEnd.Models.Auth
@using StudyVera.FrontEnd.Services.Concrats
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>StudyVera - Kayıt Ol</PageTitle>

<div class="container d-flex align-items-center justify-content-center" style="min-height: 90vh;">
    <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5" style="width: 100%; max-width: 600px; background-color: var(--bs-body-bg);">
        
        <div class="text-center mb-4">
            <h2 class="fw-bold text-info">StudyVera'ya Katılın</h2>
            <p class="text-secondary small">Dijital Koçunuzla tanışmak için bilgilerinizi girin.</p>
        </div>

        <EditForm Model="@registerModel" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <InputText @bind-Value="registerModel.FirstName" class="form-control" id="fName" placeholder="Ad" />
                        <label for="fName">Adınız</label>
                        <ValidationMessage For="@(() => registerModel.FirstName)" class="text-danger small" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        <InputText @bind-Value="registerModel.LastName" class="form-control" id="lName" placeholder="Soyad" />
                        <label for="lName">Soyadınız</label>
                        <ValidationMessage For="@(() => registerModel.LastName)" class="text-danger small" />
                    </div>
                </div>
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="registerModel.UserName" class="form-control" id="uName" placeholder="Kullanıcı Adı" />
                <label for="uName">Kullanıcı Adı</label>
                <ValidationMessage For="@(() => registerModel.UserName)" class="text-danger small" />
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="registerModel.Email" class="form-control" id="email" placeholder="E-posta" />
                <label for="email">E-posta</label>
                <ValidationMessage For="@(() => registerModel.Email)" class="text-danger small" />
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="registerModel.Password" type="password" class="form-control" id="pwd" placeholder="Şifre" />
                <label for="pwd">Şifre</label>
                <ValidationMessage For="@(() => registerModel.Password)" class="text-danger small" />
            </div>

            <div class="form-floating mb-4">
                <InputSelect @bind-Value="registerModel.TargetExam" class="form-select" id="exam">
                    <option value="">--- Sınav Seçiniz ---</option>
                    @foreach (var item in Enum.GetValues<TargetExam>())
                    {
                        <option value="@item">@item</option>
                    }
                </InputSelect>
                <label for="exam">Hedef Sınavınız</label>
                <ValidationMessage For="@(() => registerModel.TargetExam)" class="text-danger small" />
            </div>

            <button type="submit" class="btn btn-info btn-lg w-100 fw-bold rounded-pill text-white shadow-sm" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Hesap Oluşturuluyor...</span>
                }
                else
                {
                    <span>Hesap Oluştur</span>
                }
            </button>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3 shadow-sm border-0 rounded-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-exclamation-octagon-fill me-2"></i>
                        <strong class="small">Kayıt Hataları:</strong>
                    </div>
                    <ul class="mb-0 small ps-4">
                        @foreach (var error in errorMessage.Split(','))
                        {
                            <li>@error.Trim().TrimEnd('.')</li>
                        }
                    </ul>
                </div>
            }
        </EditForm>

        <div class="text-center mt-4">
            <p class="small text-secondary">Zaten hesabınız var mı? <a href="/auth/login" class="text-info text-decoration-none fw-bold">Giriş Yap</a></p>
        </div>
    </div>
</div>

@code {
    private RegisterRequest registerModel = new();
    private bool isLoading = false;
    private string? errorMessage;

    private async Task HandleRegister()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var isRegistered = await AuthService.Register(registerModel);

            if (isRegistered)
            {
                var loginRequest = new LoginRequest 
                { 
                    Email = registerModel.Email, 
                    Password = registerModel.Password 
                };

                var isLogged = await AuthService.Login(loginRequest);

                if (isLogged)
                    Navigation.NavigateTo("/profile"); 
                else
                    Navigation.NavigateTo("/auth/login"); 
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}