@page "/profile"
@using Microsoft.AspNetCore.Components.Authorization
@using StudyVera.FrontEnd.Components
@using StudyVera.FrontEnd.Models.Common
@using StudyVera.FrontEnd.Services.Concrats
@using static StudyVera.FrontEnd.Components.ScoreBoard
@using static StudyVera.FrontEnd.Pages.Auth.Register
<PageTitle>StudyVera - Profil ve Performans Analizi</PageTitle>
@inject IProfileSummaryService ProfileSummaryService
@inject IUserProfileService UserProfileService

@* ... (Mevcut using ve inject direktiflerin) ... *@

<div class="container my-5">
    @* Sayfa Başlığı ve Sınav Rozeti *@
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
        <div>
            <h2 class="text-info fw-bold mb-0">StudyVera Profilin</h2>
            <p class="text-muted mb-0 small">Performans verilerin yapay zeka ile analiz edildi.</p>
        </div>
        <span class="badge bg-primary px-3 py-2 fs-6 shadow-sm rounded-pill">
            <i class="bi bi-mortarboard-fill me-2"></i>@profileData?.TargetExam Sınavı
        </span>
    </div>

    @if (profileData == null && !isDataLoaded)
    {
        @* ... (Mevcut Loading Spinner) ... *@
    }
    else if (errorMessage != null)
    {
        @* ... (Mevcut Error Alert) ... *@
    }
    else
    {
        <div class="row g-4">
            @* SOL SÜTUN: Liderlik Tablosu (Sidebar) *@
            <div class="col-xl-4 col-lg-5">
                <div class="sticky-top" style="top: 20px; z-index: 100;">
                    <ScoreBoard />

                    @* Rozetler Kartı - Sidebar'da Skorun Altına *@
                    <div class="card shadow-sm mt-4 rounded-4 bg-info text-white border-0 overflow-hidden">
                        <div class="card-body p-4 position-relative">
                            <h5 class="fw-bold mb-3"><i class="bi bi-gem me-2"></i>Kazanılan Rozetler</h5>
                            <p class="mb-3 opacity-90">Toplam <strong>@profileData.BadgesEarned</strong> rozet kazandınız! <strong>@profileData.CurrentStreak</strong> günlük seridesiniz.</p>
                            <a href="/badges" class="btn btn-light btn-sm fw-bold text-info px-4 rounded-pill">Tümünü Gör</a>
                            <i class="bi bi-award position-absolute bottom-0 end-0 display-1 opacity-25" style="transform: translate(10%, 10%)"></i>
                        </div>
                    </div>
                </div>
            </div>

            @* SAĞ SÜTUN: Ana İstatistikler ve Grafikler *@
            <div class="col-xl-8 col-lg-7">
                @* Üst 3'lü İstatistik Kartları *@
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-primary border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Sorular</small>
                                <h4 class="fw-bold mb-0">@profileData?.TotalQuestions.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-success border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Score</small>
                                <h4 class="fw-bold mb-0">@profileData?.UserScore.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-warning border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Sıralama</small>
                                <h4 class="fw-bold mb-0">#@profileData?.GlobalRank.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                </div>

                @* Haftalık Hedef *@
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-bullseye text-success me-2"></i>Haftalık Hedef Durumu</h5>
                        <div class="progress rounded-pill mb-2" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 style="width: @profileData.GoalCompletionPercentage%">
                                %@profileData.GoalCompletionPercentage
                            </div>
                        </div>
                        <small class="text-muted">Hedefe ulaşmak için <strong>@profileData.GoalRemainingQuestions</strong> soru daha çözmelisin.</small>
                    </div>
                </div>

                @* Eksik Konular *@
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Öncelikli Eksik Konular</h5>
                        <div class="list-group list-group-flush">
                            @foreach (var topic in profileData.DeficiencyTopics.Where(x => x.Value > 100))
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                                    <span class="fw-medium">@topic.Key</span>
                                    <span class="badge bg-@(topic.Value > 200 ? "danger" : "warning") rounded-pill">
                                        @topic.Value Puan
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @* Grafik ve Heatmap Alt Alta *@
                <div class="card shadow-sm mb-4 border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="fw-bold mb-0"><i class="bi bi-graph-up text-info me-2"></i>Performans Analizi</h5>
                    </div>
                    <div class="card-body p-4">
                        @* <div class="bg-light p-4 rounded-3 text-center border mb-4">
                            <small class="text-muted">Net Artış Grafiği</small>
                        </div> *@
                        <h6 class="fw-bold mb-3 small text-uppercase text-muted">Çalışma Sürekliliği (Yıllık)</h6>
                        <div class="heatmap-scroll-container border p-2 rounded overflow-auto">
                            <Heatmap />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private string targetExamFromJwt = string.Empty;
    private TargetExam parsedTargetExam = TargetExam.TYT; 
    private bool isLoading = true;
    private bool isDataLoaded = false;
    private string? errorMessage;
    private ProfileViewModel? profileData;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(500);
        var profile = await UserProfileService.GetProfileAsync();

        try
        {
            

            profileData = await ProfileSummaryService.GetProfileSummaryAsync();
            profileData.GoalRemainingQuestions = profile.DailyStudyMinuteGoal;
            profileData.GoalCompletionPercentage = 50;
            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Profil verileri yüklenirken bir sorun oluştu: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }


    public enum TargetExam
    {
        TYT = 1,
        AYT = 2,
        DGS = 3,
        ALES = 4,
        KPSS = 5
    }

    private Dictionary<DateTime, int> GenerateMockActivityData()
    {
        var data = new Dictionary<DateTime, int>();
        var today = DateTime.Today;
        for (int i = 0; i < 365; i++)
        {
            var date = today.AddDays(-i);
            var activityLevel = new Random().Next(0, 5);
            data.Add(date, activityLevel);
        }
        return data;
    }
}
<style>
    /* Sticky Scoreboard Ayarı */
    @@media (min-width: 992px) {
        .sticky-top {
            position: -webkit-sticky;
            position: sticky;
            top: 2rem;
        }
    }

    .card {
        background-color: var(--bs-body-bg);
        transition: transform 0.2s ease-in-out;
    }

    .heatmap-scroll-container {
        min-height: 150px;
    }

    /* Bootstrap Dark Mode uyumu için list-group item renk düzeltmesi */
    .list-group-item {
        border-color: var(--bs-border-color);
        color: var(--bs-body-color);
    }
</style>