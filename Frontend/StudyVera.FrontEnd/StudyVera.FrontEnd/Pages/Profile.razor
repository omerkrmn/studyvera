@page "/profile"
@using Microsoft.AspNetCore.Components.Authorization
@using StudyVera.FrontEnd.Components
@using StudyVera.FrontEnd.Enums
@using StudyVera.FrontEnd.Models.Common
@using StudyVera.FrontEnd.Models.UserWeeklyGoals
@using StudyVera.FrontEnd.Services.Concrats

<PageTitle>StudyVera - Profil ve Performans Analizi</PageTitle>

@inject IProfileSummaryService ProfileSummaryService
@inject IUserProfileService UserProfileService
@inject IUserWeeklyGoalService UserWeeklyGoalService

<style>
    .fw-extrabold { font-weight: 800; }
    
    .pulse-animation {
        display: inline-block;
        animation: pulse-fire 2s infinite;
    }

    @@keyframes pulse-fire {
        0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(220, 53, 69, 0)); }
        50% { transform: scale(1.15); filter: drop-shadow(0 0 5px rgba(220, 53, 69, 0.5)); }
        100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(220, 53, 69, 0)); }
    }

    .streak-icon-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
        <div>
            <h2 class="text-info fw-bold mb-0">StudyVera Profilin</h2>
            <p class="text-muted mb-0 small">Performans verilerin yapay zeka ve matematiksel modellerle analiz edildi.</p>
        </div>
        @if (profileData != null)
        {
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center bg-warning bg-opacity-10 px-3 py-2 rounded-pill shadow-sm border border-warning border-opacity-25 animate__animated animate__bounceIn">
                    <div class="streak-icon-container me-2">
                        <i class="bi bi-fire text-danger fs-4 pulse-animation"></i>
                    </div>
                    <div class="d-flex flex-column">
                        <span class="fw-extrabold lh-1" style="font-size: 1.1rem;">@profileData.CurrentStreak GÜN</span>
                        <span class="text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">KESİNTİSİZ SERİ</span>
                    </div>
                </div>

                <span class="badge bg-primary px-3 py-2 fs-6 shadow-sm rounded-pill animate__animated animate__fadeIn d-flex align-items-center" style="height: fit-content;">
                    <i class="bi bi-mortarboard-fill me-2"></i>@profileData.TargetExam Sınavı
                </span>
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger d-flex align-items-center rounded-4 shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <h6 class="alert-heading fw-bold mb-1">Veri Yükleme Hatası</h6>
                <span>@errorMessage</span>
                <button class="btn btn-sm btn-outline-danger ms-3 rounded-pill" @onclick="OnInitializedAsync">Tekrar Dene</button>
            </div>
        </div>
    }
    else if (isDataLoaded && profileData != null)
    {
        <div class="row g-4">
            @* SOL SÜTUN: Liderlik Tablosu ve Rozetler *@
            <div class="col-xl-4 col-lg-5">
                <div class="sticky-top">
                    <ScoreBoard />

                    <div class="card shadow-sm mt-4 rounded-4 bg-info text-white border-0 overflow-hidden">
                        <div class="card-body p-4 position-relative">
                            <h5 class="fw-bold mb-3"><i class="bi bi-gem me-2"></i>Kazanılan Rozetler</h5>
                            <p class="mb-3 opacity-90">Toplam <strong>@profileData.BadgesEarned</strong> rozet kazandınız! <strong>@profileData.CurrentStreak</strong> günlük seridesiniz.</p>
                            <a href="/badges" class="btn btn-light btn-sm fw-bold text-info px-4 rounded-pill">Tümünü Gör</a>
                            <i class="bi bi-award position-absolute bottom-0 end-0 display-1 opacity-25" style="transform: translate(10%, 10%)"></i>
                        </div>
                    </div>
                </div>
            </div>

            @* SAĞ SÜTUN: Ana İstatistikler ve Hedef *@
            <div class="col-xl-8 col-lg-7">
                @* Üst 3'lü İstatistik Kartları *@
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-primary border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Sorular</small>
                                <h4 class="fw-bold mb-0">@profileData.TotalQuestions.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-success border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Puan</small>
                                <h4 class="fw-bold mb-0">@profileData.UserScore.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-0 border-top border-warning border-4 h-100">
                            <div class="card-body text-center p-3">
                                <small class="text-uppercase text-muted fw-bold d-block mb-1">Sıralama</small>
                                <h4 class="fw-bold mb-0">#@profileData.GlobalRank.ToString("N0")</h4>
                            </div>
                        </div>
                    </div>
                </div>

                @* Haftalık Hedef - Yeni Servis Verisiyle *@
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0"><i class="bi bi-bullseye text-success me-2"></i>Haftalık Hedef Durumu</h5>
                            @if (weeklyGoal != null)
                            {
                                <span class="badge bg-success-subtle text-success rounded-pill px-3">
                                    %@weeklyGoal.CompletionPercentage.ToString("N1")
                                </span>
                            }
                        </div>

                        <div class="progress rounded-pill mb-2" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 role="progressbar"
                                 style="width: @(weeklyGoal?.CompletionPercentage ?? 0)%">
                            </div>
                        </div>

                        <small class="text-muted">
                            @if (weeklyGoal?.IsGoalAchieved == true)
                            {
                                <span class="text-success fw-bold"><i class="bi bi-check-circle-fill me-1"></i> Tebrikler! Haftalık soru hedefine ulaştın.</span>
                            }
                            else
                            {
                                <span>Hedefe ulaşmak için <strong>@(weeklyGoal?.RemainingQuestions ?? 0)</strong> soru daha çözmelisin.</span>
                            }
                        </small>
                    </div>
                </div>

                @if (profileData.DeficiencyTopics.Where(x => x.Value > 100).Any())
                {

                    <div class="card shadow-sm mb-4 border-0 rounded-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Öncelikli Eksik Konular</h5>
                            <div class="list-group list-group-flush">
                                @foreach (var topic in profileData.DeficiencyTopics.Where(x => x.Value > 100))
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                                        <span class="fw-medium">@topic.Key</span>
                                        <span class="badge bg-@(topic.Value > 200 ? "danger" : "warning") rounded-pill shadow-sm">
                                            @topic.Value Puan
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                @* Performans Analizi *@
                <div class="card shadow-sm mb-4 border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <h5 class="fw-bold mb-0"><i class="bi bi-graph-up text-info me-2"></i>Çalışma Sürekliliği</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="heatmap-scroll-container border p-2 rounded overflow-auto bg-body-tertiary">
                            <Heatmap />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private bool isDataLoaded = false;
    private string? errorMessage;
    private ProfileViewModel? profileData;
    private UserWeeklyGoalDto? weeklyGoal;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileData();
    }

    private async Task LoadProfileData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var profileTask = ProfileSummaryService.GetProfileSummaryAsync();
            var weeklyGoalTask = UserWeeklyGoalService.GetUserWeeklyGoal();

            await Task.WhenAll(profileTask, weeklyGoalTask);

            profileData = profileTask.Result;
            weeklyGoal = weeklyGoalTask.Result;

            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}