@page "/profile"
@using Microsoft.AspNetCore.Components.Authorization
@using StudyVera.FrontEnd.Components
@using StudyVera.FrontEnd.Services.Common
@using static StudyVera.FrontEnd.Pages.Auth.Register
<PageTitle>StudyVera - Profil ve Performans Analizi</PageTitle>
@inject UserSettingsService UserSettings

<div class="container my-5">
    <h2 class="text-info fw-bold mb-4 border-bottom pb-2 d-flex justify-content-between align-items-center">
        StudyVera Profilin
        <span class="badge bg-primary fs-6">@profileData?.TargetExam Sınavı</span>
    </h2>

    @if (profileData == null && !isDataLoaded)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-3 text-muted">Veriler yükleniyor, lütfen bekleyin...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-x-octagon-fill me-2"></i> @errorMessage
        </div>
    }
    else
    {
        <div class="row g-4 mb-5">
            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-start border-primary border-5 rounded-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-primary text-uppercase mb-2 fw-semibold">
                                    Toplam Soru
                                </h6>
                                <h3 class="fw-bold mb-0">
                                    @profileData?.TotalQuestions.ToString("N0")
                                </h3>
                            </div>
                            <i class="bi bi-clipboard-check-fill text-primary display-4 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-start border-success border-5 rounded-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-success text-uppercase mb-2 fw-semibold">
                                    StudyVera Score
                                </h6>
                                <h3 class="fw-bold mb-0">
                                    @profileData?.UserScore.ToString("N0")
                                </h3>
                            </div>
                            <i class="bi bi-star-fill text-success display-4 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card shadow-sm h-100 border-start border-warning border-5 rounded-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-warning text-uppercase mb-2 fw-semibold">
                                    Global Sıralama
                                </h6>
                                <h3 class="fw-bold mb-0">
                                    #@profileData?.GlobalRank.ToString("N0")
                                </h3>
                            </div>
                            <i class="bi bi-trophy-fill text-warning display-4 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-lg p-4 rounded-4 mb-5">
            <h4 class="card-title fw-semibold mb-3 text-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> Öncelikli Eksik Konular
            </h4>
            <p class="text-muted">
                Yapay zeka analizine göre, bu konulara odaklanmanız skorunuzu en hızlı şekilde yükseltecektir.
            </p>
            <ul class="list-group list-group-flush">
                @foreach (var topic in profileData.WeakTopics)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        @topic.Key
                        <span class="badge bg-danger rounded-pill">
                            %@topic.Value Başarı Oranı
                        </span>
                    </li>
                }
            </ul>
        </div>
        
        <div class="card shadow-lg p-4 rounded-4 mb-5">
            <h4 class="card-title fw-semibold mb-3 text-info">
                <i class="bi bi-graph-up me-2"></i> Son 4 Haftalık Performans
            </h4>
            <p class="text-muted">
                Son dönemdeki net artışınızı ve çalışma yoğunluğunuzu izleyin.
            </p>
            
            <div class="bg-light p-4 rounded-3 text-center border"><small class="text-muted">Net Artış/Azalış Grafiği Simülasyonu</small>
            </div>
        </div>

        <div class="card shadow-lg p-4 rounded-4 mb-5">
            <h4 class="card-title fw-semibold mb-3">
                <i class="bi bi-fire me-2 text-danger"></i> Çalışma Sürekliliği Haritası
            </h4>
            <p class="text-muted mb-4">
                Son bir yıldaki çalışma günleriniz ve yoğunluğunuz. Koyu renkler yüksek aktiviteyi gösterir.
            </p>

            <Heatmap/>
        </div>
        
        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="card h-100 shadow-sm p-4 rounded-4 bg-info text-white">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="bi bi-gem me-2"></i> Kazanılan Rozetler
                    </h5>
                    <p class="card-text">
                        Toplam **@profileData.BadgesEarned** rozet kazandınız! Bunlardan **@profileData.CurrentStreak** günlük kesintisiz çalışma serisine sahipsiniz.
                    </p>
                    <a href="/badges" class="btn btn-light mt-2 fw-semibold text-info">Tüm Rozetleri Gör</a>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100 shadow-sm p-4 rounded-4 border border-info border-3">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="bi bi-bullseye me-2 text-success"></i> Haftalık Hedef Durumu
                    </h5>
                    <p class="card-text text-muted">
                        Haftalık hedefinize ulaşmaya **@profileData.GoalRemainingQuestions** soru kaldı.
                    </p>
                    <div class="progress mt-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped bg-success fw-bold" role="progressbar" 
                             style="width: @profileData.GoalCompletionPercentage%" 
                             aria-valuenow="@profileData.GoalCompletionPercentage" aria-valuemin="0" aria-valuemax="100">
                             %@profileData.GoalCompletionPercentage
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private string targetExamFromJwt = string.Empty;
    private TargetExam parsedTargetExam = TargetExam.TYT; 
    private bool isLoading = true;
    private bool isDataLoaded = false;
    private string? errorMessage;
    private ProfileViewModel? profileData;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(500);
        var settings = await UserSettings.Load();
        try
        {
            profileData = new ProfileViewModel
            {
                UserName = "VeraBaşarılıÖğrenci",
                Email = "basarili@studyvera.com",

                TargetExam =settings.TargetExam,

                TotalQuestions = 78945,
                UserScore = 2105,
                GlobalRank = 123,
                BadgesEarned = 12,
                CurrentStreak = 42,
                GoalRemainingQuestions = 150,
                GoalCompletionPercentage = 95,
                WeakTopics = new Dictionary<string, int>
                {
                    { "Fizik: Elektrik ve Manyetizma", 51 },
                    { "Edebiyat: Divan Şiiri", 60 },
                    { "Matematik: Türev", 58 }
                },
                ActivityData = GenerateMockActivityData() 
            };


            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Profil verileri yüklenirken bir sorun oluştu: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    
    public class ProfileViewModel
    {
        public string UserName { get; set; } = "StudyVeraKullanicisi";
        public string Email { get; set; } = "user@studyvera.com";
        public string TargetExam { get; set; } = "TYT & AYT";
        public int TotalQuestions { get; set; } = 78945;
        public int UserScore { get; set; } = 2105;
        public int GlobalRank { get; set; } = 123;

        public int BadgesEarned { get; set; } = 8;
        public int CurrentStreak { get; set; } = 35;
        public int GoalRemainingQuestions { get; set; } = 250;
        public int GoalCompletionPercentage { get; set; } = 75;

        public Dictionary<DateTime, int> ActivityData { get; set; } = new();

        public Dictionary<string, int> WeakTopics { get; set; } = new()
        {
            { "Kimya: Çözeltiler", 55 },
            { "Matematik: Trigonometri", 62 },
            { "Biyoloji: Kalıtım", 59 }
        };

    }

    public enum TargetExam
    {
        TYT = 1,
        AYT = 2,
        DGS = 3,
        ALES = 4,
        KPSS = 5
    }

    private Dictionary<DateTime, int> GenerateMockActivityData()
    {
        var data = new Dictionary<DateTime, int>();
        var today = DateTime.Today;
        for (int i = 0; i < 365; i++)
        {
            var date = today.AddDays(-i);
            var activityLevel = new Random().Next(0, 5);
            data.Add(date, activityLevel);
        }
        return data;
    }
}