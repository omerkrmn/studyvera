@using Blazored.LocalStorage
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using StudyVera.FrontEnd.Models.LessonSchedules
@using StudyVera.FrontEnd.Services.Concrats
@inject ILocalStorageService LocalStorage
@inject ILessonScheduleService LessonScheduleService

<h3 class="mt-3 mb-3">📘 Haftalık Çalışma Programı</h3>

<div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-primary">
            <tr>
                @foreach (var day in WeeklyProgram)
                {
                    <th>@day.DayName</th>
                }
            </tr>
        </thead>

        <tbody>
            <tr class="align-text-top">
                @foreach (var day in WeeklyProgram)
                {
                    <td style="min-width:150px; height: 100%;"
                        @ondragover:preventDefault
                        @ondragover="HandleDragEnter"
                        @ondrop="() => HandleDayDrop(day)">

                        @if (day.Schedules.Count == 0)
                        {
                            <div class="text-muted" style="min-height:70px;">—</div>
                        }
                        else
                        {
                            @foreach (var schedule in day.Schedules.OrderBy(s => s.StartTime))
                            {
                                string dropClass = "";
                                if (schedule == targetScheduleForDrop)
                                {
                                    dropClass = dropIndicatorClass;
                                }

                                <div class="p-1 mb-1 border rounded shadow-sm @dropClass"
                                     draggable="true"
                                     @ondragstart="() => HandleDragStart(schedule, day)"
                                     @ondragover:preventDefault
                                     @ondragover="(args) => HandleDragOverSession(schedule, args)"
                                     @ondragleave="() => HandleDragLeave(schedule)"
                                     @ondrop:stopPropagation
                                     @ondrop="() => HandleSessionDrop(day, schedule)"
                                     style="cursor: move; /* Topic rengi DTO'da olmadığı için varsayılan bırakıldı */">

                                    <strong>Topic ID: @schedule.TopicId</strong> <br />

                                    <small class="text-secondary">
                                        @schedule.StartTime.Hours:@schedule.StartTime.Minutes:00 -
                                        @schedule.EndTime.Hours:@schedule.EndTime.Minutes:00
                                    </small>
                                    <br />

                                    <small class="text-dark">Lesson ID: @schedule.LessonId</small>
                                </div>
                            }
                        }
                    </td>
                }
            </tr>
        </tbody>
    </table>
</div>


@code {
   
    private LessonScheduleDto? draggedSchedule;
    private DayProgramView? sourceDay;
    private List<DayProgramView> WeeklyProgram { get; set; } = new List<DayProgramView>();
    private LessonScheduleDto? targetScheduleForDrop;
    private string? dropIndicatorClass;
    private string HataMesaji { get; set; } = string.Empty;


    protected override async Task OnInitializedAsync()
    {
        List<LessonScheduleDto> schedules;
        HataMesaji = string.Empty;

        var storedSchedules = await LocalStorage.GetItemAsync<List<LessonScheduleDto>>("lessonSchedules");

        if (storedSchedules != null && storedSchedules.Any())
        {
            schedules = storedSchedules;
        }
        else
        {
            try
            {
                schedules = await LessonScheduleService.GetAll();
            }
            catch (Exception ex)
            {
                schedules = new List<LessonScheduleDto>();
                HataMesaji = $"Program yüklenirken bir sorun oluştu: {ex.Message}";
                Console.WriteLine(HataMesaji);
            }
        }
        WeeklyProgram = GroupSchedulesByDay(schedules);
    }

    private void HandleDragStart(LessonScheduleDto schedule, DayProgramView day)
    {
        draggedSchedule = schedule;
        sourceDay = day;
        targetScheduleForDrop = null;
        dropIndicatorClass = null;
    }

    private void HandleDragEnter(DragEventArgs args)
    {
        args.DataTransfer.DropEffect = "move";
    }

    private void HandleDragOverSession(LessonScheduleDto targetSchedule, DragEventArgs args)
    {
        if (draggedSchedule == null || draggedSchedule.LessonId == targetSchedule.LessonId) return;

        targetScheduleForDrop = targetSchedule;
        dropIndicatorClass = "drop-zone-top";
        args.DataTransfer.DropEffect = "move";
    }

    private void HandleDragLeave(LessonScheduleDto targetSchedule)
    {
        if (targetScheduleForDrop == targetSchedule)
        {
            targetScheduleForDrop = null;
            dropIndicatorClass = null;
        }
    }

    private async Task HandleSessionDrop(DayProgramView targetDay, LessonScheduleDto targetSchedule)
    {
        if (draggedSchedule == null || sourceDay == null) return;

        sourceDay.Schedules.Remove(draggedSchedule);

        int insertIndex = targetDay.Schedules.IndexOf(targetSchedule);

        draggedSchedule.DayOfWeek = targetDay.DayOfWeek;

        targetDay.Schedules.Insert(insertIndex, draggedSchedule);

        await SaveAndCleanup();
    }

    private async Task HandleDayDrop(DayProgramView targetDay)
    {
        if (draggedSchedule == null || sourceDay == null) return;
        if (sourceDay == targetDay) return;

        sourceDay.Schedules.Remove(draggedSchedule);

        draggedSchedule.DayOfWeek = targetDay.DayOfWeek;
        targetDay.Schedules.Add(draggedSchedule);

        await SaveAndCleanup();
    }


    private async Task SaveAndCleanup()
    {
        var allSchedules = WeeklyProgram.SelectMany(d => d.Schedules).ToList();

        await LocalStorage.SetItemAsync("WeeklySchedulesData", allSchedules);


        StateHasChanged();

        draggedSchedule = null;
        sourceDay = null;
        targetScheduleForDrop = null;
        dropIndicatorClass = null;
    }

    private List<DayProgramView> GroupSchedulesByDay(List<LessonScheduleDto> schedules)
    {
        var days = new List<DayProgramView>();
        var dayNames = new[] { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar" };

        for (int i = 0; i < 7; i++)
        {
            int dayIndex = i + 1;

            days.Add(new DayProgramView
            {
                DayOfWeek = dayIndex,
                DayName = dayNames[i],
                Schedules = schedules
                    .Where(s => s.DayOfWeek == dayIndex)
                    .OrderBy(s => s.StartTime)
                    .ToList()
            });
        }
        return days;
    }

    public class DayProgramView
    {
        public int DayOfWeek { get; set; }
        public string DayName { get; set; } = string.Empty;
        public List<LessonScheduleDto> Schedules { get; set; } = new List<LessonScheduleDto>();
    }

 
}