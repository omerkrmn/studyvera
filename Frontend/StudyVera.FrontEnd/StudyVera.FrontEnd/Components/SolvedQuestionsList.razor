@using StudyVera.FrontEnd.Models.Topics
@using StudyVera.FrontEnd.Models.UserQuestionStat
@using StudyVera.FrontEnd.Services.Concrats
@inject IUserQuestionStatsService UserQuestionStatsService
@inject IQuestionStatDetailService QuestionStatDetailService

<div class="table-responsive">
    <table class="table table-hover caption-top">
        <thead class="table-dark">
            <tr>
                <th scope="col" style="width: 30%;" class="fw-bold">Konu Adı</th>
                <th scope="col" class="text-center">Çözülen (Adet)</th>
                <th scope="col" class="text-center">Doğru (Adet)</th>
                <th scope="col" class="text-center">Yanlış (Adet)</th>
                <th scope="col" class="text-center">Doğruluk Oranı</th>
                <th scope="col" class="text-center" style="width: 15%;">Son Güncelleme</th>
            </tr>
        </thead>
        <tbody>
            @if (Questions == null || !Questions.Any())
            {
                <tr>
                    <td colspan="6" class="text-center text-muted p-4">Henüz çözülmüş soru kaydı bulunmamaktadır.</td>
                </tr>
            }
            else
            {
                @foreach (var question in Questions)
                {
                    float eksik = CalculateDeficiencyScore(question.TotalSolvedCount, question.TotalCorrectCount, question.LastAttemptAt, question.TopicId);
                    var isExpanded = expandedId == question.Id;
                    <tr class="align-middle"
                        title="konu eksik skoru : @eksik"
                        style="cursor: pointer;"
                        @ondblclick="@(() => ToggleExpand(question))">

                        <th scope="row" class="fw-bold">@question.Topic.Name</th>
                        <td class="text-center">@question.TotalSolvedCount</td>
                        <td class="text-center text-success fw-bold">@question.TotalCorrectCount</td>
                        <td class="text-center text-danger">@question.TotalWrongCount</td>
                        <td class="text-center">
                            <span class="badge @(question.AccuracyRate >= 0.75 ? "bg-success" : question.AccuracyRate >= 0.50 ? "bg-warning text-dark" : "bg-danger")">
                                @question.AccuracyRate%
                            </span>
                        </td>
                        <td class="text-center small">@question.LastAttemptAt.ToShortDateString()</td>
                    </tr>

                    @if (isExpanded)
                    {
                        @if (question.QuestionStatDetail != null && question.QuestionStatDetail.Any())
                        {
                            @foreach (var item in question.QuestionStatDetail)
                            {


                                <tr class="table-secondary">
                                    <td></td>
                                    <td class="text-center">@item.SolvedCount</td>
                                    <td class="text-center text-success fw-bold">@item.CorrectCount</td>
                                    <td class="text-center text-danger">@item.WrongCount</td>
                                    <td class="text-center">
                                        <span class="badge @((float)item.CorrectCount / item.SolvedCount >= 0.75 ? "bg-success" : ((float)item.CorrectCount / item.SolvedCount) >= 0.50 ? "bg-warning text-dark" : "bg-danger")">
                                            @((float)item.CorrectCount / item.SolvedCount)%
                                        </span>
                                    </td>
                                    <td class="text-center small">@item.AttemptedAt.ToShortDateString()</td>
                                </tr>
                            }
                        }
                    }
                }

            }
        </tbody>
    </table>
</div>
@code {
    [Parameter] public List<UserQuestionStatDto> Questions { get; set; } = new();
    [Parameter] public List<TopicDto> Topics { get; set; } = new();

    private int? expandedId;

    private async Task ToggleExpand(UserQuestionStatDto question)
    {
        if (expandedId == question.Id)
        {
            expandedId = null;
        }
        else
        {
            expandedId = question.Id;

            if (question.QuestionStatDetail == null || !question.QuestionStatDetail.Any())
            {
                var details = await QuestionStatDetailService.GetAll(question.Id);
                question.QuestionStatDetail = details.ToList();
            }
        }

        StateHasChanged();
    }
    public float CalculateDeficiencyScore(int totalSolvedCount, int correctCount, DateTime lastAttemptAt, float topicPriority)
    {
        const float expectedSuccessRate = 0.60f; 
        const float successWeight = 0.7f;        
        const float recencyWeight = 0.3f;        
        const int confidenceThreshold = 10;     
        const int recencyLimitDays = 90;        

        int daysSinceLastAttempt = (DateTime.Now - lastAttemptAt).Days;
        float recencyScore = Math.Min(daysSinceLastAttempt, recencyLimitDays);

        float adjustedSuccessRatio = ((float)correctCount + (confidenceThreshold * expectedSuccessRate))
                                    / (totalSolvedCount + confidenceThreshold);

        float successPercentage = adjustedSuccessRatio * 100f;
        float successLossScore = 100f - successPercentage;

        float deficiencyScore = (successWeight * successLossScore) + (recencyWeight * recencyScore);

        return deficiencyScore * topicPriority;
    }
}
